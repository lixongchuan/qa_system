{% extends 'layout.html' %}

{% block content %}
<div class="columns">
    <!-- å±…ä¸­å¸ƒå±€ -->
    <div class="column col-10 col-lg-12 col-mx-auto">
        
        <!-- è¿”å›é¦–é¡µå¯¼èˆª -->
        <div style="margin-bottom: 15px;">
            <a href="/" class="btn btn-link pl-0 text-gray" style="text-decoration: none;">
                <i class="ri-arrow-left-line"></i> è¿”å›é¦–é¡µ
            </a>
        </div>

        <!-- ================= 1. é—®é¢˜è¯¦æƒ…å¡ç‰‡ ================= -->
        <div class="card mb-4" style="border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border-left: 5px solid #5E5DF0;">
            <div class="card-body" style="padding: 2rem;">
                <!-- æ ‡é¢˜ -->
                <h1 style="font-size: 1.8rem; font-weight: 800; margin-bottom: 1rem; color: #172B4D;">
                    {{ question_answer_dict.question_title }}
                </h1>
                
                <!-- é—®é¢˜è¯¦æƒ…å†…å®¹ -->
                <div style="font-size: 1.1rem; line-height: 1.8; color: #42526E;">
                    {{ question_answer_dict.question_detail }}
                </div>
            </div>
            
            <div class="card-footer text-right pb-3 pr-3">
                <!-- [æƒé™æ§åˆ¶] åˆ é™¤é—®é¢˜æŒ‰é’®ï¼šä»…ä½œè€…æœ¬äºº æˆ– ç®¡ç†å‘˜å¯è§ -->
                {% if current_user.is_authenticated and (current_user.id == question_answer_dict.question_author_id or current_user.is_admin) %}
                    <button class="btn btn-link text-error mr-2" 
                            onclick="deleteContent('{{question_answer_dict.question_id}}', 'question', '{{question_answer_dict.question_author_id}}')">
                        <i class="ri-delete-bin-line"></i> åˆ é™¤é—®é¢˜
                    </button>
                {% endif %}
                
                <!-- å›ç­”æŒ‰é’® -->
                {% if current_user.is_authenticated %}
                    <button class="btn btn-primary" onclick="$('#answer-modal').addClass('active')">
                       <i class="ri-edit-line"></i> æˆ‘æ¥ç­”ä¸€æ³¢
                    </button>
                {% else %}
                    <a href="/login" class="btn btn-primary">ç™»å½•åå›ç­”</a>
                {% endif %}
            </div>
        </div>
        
        <!-- åˆ†å‰²çº¿ & ç»Ÿè®¡ -->
        <div class="divider text-center" data-content="{{ question_answer_dict.answer_num }} ä¸ªå›ç­”" style="margin: 2rem 0; color: #b2bec3;"></div>

        <!-- ================= 2. å›ç­”åˆ—è¡¨å¾ªç¯ ================= -->
        {% for answer in question_answer_dict.answer_list %}
        
        <!-- å¦‚æœæ˜¯ç½®é¡¶å›ç­”ï¼Œæ·»åŠ ç‰¹æ®Šæ ·å¼ (é‡‘è‰²è¾¹æ¡†å’Œæµ…é»„èƒŒæ™¯) -->
        <div class="card mb-3 fade-in-up" 
             style="border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.03); 
                    {% if answer.is_pinned %}border: 2px solid #FFD700; background: #FFFBE6;{% endif %}">
            
            <div class="card-body">
                <div class="tile">
                    <!-- åœ¨ answer å¾ªç¯ä¸­ -->
                    <div class="tile-icon">
                        <a href="/u/{{ answer.author_id }}">
                            <figure class="avatar avatar-lg">
                                <img src="{{ url_for('static', filename='uploads/' + answer.author_avatar) }}">
                            </figure>
                        </a>
                    </div>
                    <div class="tile-content ml-2">
                        <div class="tile-title text-bold">
                            <a href="/u/{{ answer.author_id }}" style="color: inherit; text-decoration: none;">
                                {{ answer.answer_author }}
                            </a>
                            
                           <!-- === æ–°å¢ï¼šç®¡ç†å‘˜æ ‡è¯† === -->
                            {% if answer.author_role == 'admin' %}
                                <span style="background: #FFF7E6; color: #FA8C16; border: 1px solid #FFD591; padding: 1px 6px; border-radius: 4px; font-size: 0.7rem; margin-left: 6px; vertical-align: middle;">
                                    <i class="ri-shield-check-fill mr-1"></i> å®˜æ–¹è®¤è¯
                                </span>
                            {% endif %}

                            <!-- ç½®é¡¶æ ‡ç­¾ (ä¿æŒä¸å˜) -->
                            {% if answer.is_pinned %}
                                <span class="label label-warning ml-2" style="background:#FFD700; color:#fff;">
                                    <i class="ri-pushpin-2-fill"></i> å·²ç½®é¡¶
                                </span>
                            {% endif %}
                            
                            <!-- [ç®¡ç†å‘˜æƒé™] å°ç¦ç”¨æˆ·æŒ‰é’® -->
                            {% if current_user.is_admin and current_user.id != answer.author_id %}
                                <!-- ä¿®æ”¹ç‚¹ï¼šå¢åŠ äº† tooltip-right å’Œä¸€äº›æ ·å¼è°ƒæ•´ -->
                                <button class="btn btn-link btn-sm text-gray ml-2 tooltip tooltip-right" 
                                        data-tooltip="å°ç¦è¯¥ç”¨æˆ·"
                                        style="line-height: 1; vertical-align: middle; height: auto; padding: 0 5px;"
                                        onclick="banUser('{{answer.author_id}}')">
                                    <i class="ri-prohibited-line" style="font-size: 1.1em; color: #666;"></i>
                                </button>
                            {% endif %}
                        </div>
                        <div class="text-gray" style="font-size: 0.8rem;">å‘å¸ƒäº åˆšåˆš</div>
                    </div>
                </div>
                
                <div style="margin-top: 15px; font-size: 1rem; line-height: 1.7; color: #2d3436;">
                    {{ answer.answer_detail }}
                </div>
            </div>
            
            <!-- åº•éƒ¨æ“ä½œæ  -->
            <div class="card-footer pt-2">
                <!-- èµåŒæŒ‰é’® -->
                 <button class="vote-btn mr-2 {% if answer.is_upvoted %}active-up{% endif %}" 
                    id="a-up-{{answer.answer_id}}"
                    onclick="vote('{{answer.answer_id}}', 'answer', 'vote_up')">
                    <i class="ri-thumb-up-line"></i> <span id="count-answer-{{answer.answer_id}}">{{answer.answer_vote}}</span>
                </button>

                <!-- åå¯¹æŒ‰é’® -->
                <button class="vote-btn {% if answer.is_downvoted %}active-down{% endif %}" 
                    id="a-down-{{answer.answer_id}}"
                    onclick="vote('{{answer.answer_id}}', 'answer', 'vote_down')">
                    <i class="ri-thumb-down-line"></i>
                </button>

                <!-- [ç®¡ç†å‘˜æƒé™] ç½®é¡¶/å–æ¶ˆç½®é¡¶ -->
                {% if current_user.is_admin %}
                    <button class="btn btn-link btn-sm ml-2" onclick="pinAnswer('{{answer.answer_id}}')">
                        {% if answer.is_pinned %}
                            <span class="text-warning"><i class="ri-unpin-line"></i> å–æ¶ˆç½®é¡¶</span>
                        {% else %}
                            <span class="text-gray"><i class="ri-pushpin-line"></i> ç½®é¡¶</span>
                        {% endif %}
                    </button>
                {% endif %}

                <!-- [æƒé™æ§åˆ¶] åˆ é™¤å›ç­”æŒ‰é’®ï¼šä½œè€…æœ¬äºº æˆ– ç®¡ç†å‘˜ -->
                {% if current_user.is_authenticated and (current_user.id == answer.author_id or current_user.is_admin) %}
                    <button class="btn btn-link btn-sm text-error float-right" 
                            onclick="deleteContent('{{answer.answer_id}}', 'answer', '{{answer.author_id}}')">
                        <i class="ri-delete-bin-line"></i> åˆ é™¤
                    </button>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- å†™å›ç­”å¼¹çª— -->
<div class="modal" id="answer-modal">
    <a href="#close" class="modal-overlay" aria-label="Close"></a>
    <div class="modal-container" style="border-radius: 12px;">
        <div class="modal-header">
            <a href="#close" class="btn btn-clear float-right" aria-label="Close"></a>
            <div class="modal-title h5">ğŸ“ æ’°å†™å›ç­”</div>
        </div>
        <div class="modal-body">
            <div class="content">
                <textarea class="form-input" id="answer-content" rows="6" placeholder="å‹å–„äº¤æµï¼Œä¸ä»…è§£å†³é—®é¢˜ï¼Œæ›´æ¸©æš–äººå¿ƒ..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="postAnswer()">å‘å¸ƒå›ç­”</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// å…¨å±€å˜é‡ï¼Œè·å–å½“å‰é—®é¢˜ID
var q_id = "{{ question_answer_dict.question_id }}";

// 1. å‘å¸ƒå›ç­” (å·²æ›´æ–°ï¼šå¤„ç†å°ç¦é”™è¯¯ä¿¡æ¯)
function postAnswer(){
    var content = $('#answer-content').val();
    if(!content) { alert("ä¸€ä¸ªå­—éƒ½ä¸å†™å—ï¼Ÿ"); return; }
    
    $.ajax({
        type: "post",
        url: '/post_answer',
        data: JSON.stringify({question_id: q_id, answer: content}),
        contentType: "application/json",
        success: function(res) { 
            // å¦‚æœåç«¯è¿”å› success
            if(res.status === 'success') {
                window.location.reload(); 
            } else {
                // å¦‚æœè¢«å°ç¦ï¼Œres.status ä¼šæ˜¯ 'fail'ï¼Œå¹¶ä¸”æœ‰ msg
                alert("å‘å¸ƒå¤±è´¥ï¼š" + res.msg);
                $('.modal').removeClass('active'); // å…³é—­å¼¹çª—
            }
        },
        error: function() {
            alert("ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åå†è¯•");
        }
    });
}

// 2. åˆ é™¤å†…å®¹ (é—®é¢˜æˆ–å›ç­”)
function deleteContent(id, type, authorId) {
    var tip = (type === 'question') ? 'åˆ é™¤é—®é¢˜å°†ä¼šè¿åŒåˆ é™¤å…¶ä¸‹çš„æ‰€æœ‰å›ç­”ï¼Œç¡®å®šå—ï¼Ÿ' : 'ç¡®å®šè¦åˆ é™¤è¿™æ¡å›ç­”å—ï¼Ÿ';
    if(!confirm(tip)) return;
    
    $.ajax({
        type: "post",
        url: '/delete_content',
        data: JSON.stringify({id: id, type: type, author_id: authorId}),
        contentType: "application/json",
        success: function(res) {
            if(res.status === 'success') {
                if(type === 'question') {
                    // å¦‚æœåˆ äº†é—®é¢˜ï¼Œè·³å›é¦–é¡µ
                    window.location.href = '/';
                } else {
                    // å¦‚æœåˆ äº†å›ç­”ï¼Œåˆ·æ–°å½“å‰é¡µ
                    window.location.reload();
                }
            } else {
                alert(res.msg);
            }
        }
    });
}

// 3. ç®¡ç†å‘˜ï¼šç½®é¡¶å›ç­”
function pinAnswer(aid) {
    $.ajax({
        type: "post",
        url: '/admin/pin_answer',
        data: JSON.stringify({answer_id: aid}),
        contentType: "application/json",
        success: function(res) {
            if(res.status === 'success') {
                window.location.reload();
            } else {
                alert(res.msg);
            }
        }
    });
}

// 4. ç®¡ç†å‘˜ï¼šå°ç¦ç”¨æˆ·
function banUser(uid) {
    var days = prompt("ğŸ‘®â€â™‚ï¸ ç®¡ç†å‘˜æ“ä½œ\n\nè¯·è¾“å…¥å°ç¦å¤©æ•° (ä¾‹å¦‚: 3)ï¼š", "3");
    if(days != null && days.trim() !== "") {
        $.ajax({
            type: "post",
            url: '/admin/ban_user',
            data: JSON.stringify({user_id: uid, days: days}),
            contentType: "application/json",
            success: function(res) {
                alert(res.msg);
            },
            error: function() {
                alert("æ“ä½œå¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™");
            }
        });
    }
}

// 5. æŠ•ç¥¨é€»è¾‘ (å¤ç”¨ä¹‹å‰çš„)
function vote(id, type, val){
    var btnUp = $('#a-up-'+id);
    var btnDown = $('#a-down-'+id);
    var countSpan = $('#count-'+type+'-'+id);

    $.ajax({
        type: "post",
        url: '/vote',
        data: JSON.stringify({doc_id: id, doc_type: type, value: val}),
        contentType: "application/json",
        success: function(data) {
            countSpan.text(data.new_count);
            if (val === 'vote_up') {
                if(btnUp.hasClass('active-up')) {
                    btnUp.removeClass('active-up');
                } else {
                    btnUp.addClass('active-up');
                    btnDown.removeClass('active-down');
                }
            } else {
                if(btnDown.hasClass('active-down')) {
                    btnDown.removeClass('active-down');
                } else {
                    btnDown.addClass('active-down');
                    btnUp.removeClass('active-up');
                }
            }
        },
        error: function() {
            alert('è¯·å…ˆç™»å½•ï¼');
            window.location.href = '/login';
        }
    });
}
</script>
<style>
    /* ç®€å•çš„æ ·å¼è¡¥å…… */
    .vote-btn {
        background: #f4f6f8; border: none; color: #66757f;
        padding: 4px 12px; border-radius: 4px; cursor: pointer;
        display: inline-flex; align-items: center; transition: all 0.2s;
    }
    .vote-btn:hover { background: #e1e8ed; color: #0066FF; }
    .vote-btn.active-up { background: #E6F0FF; color: #0066FF; font-weight: bold; }
    .vote-btn.active-down { background: #FFF0EB; color: #DE350B; }

    /* 1. å¼ºåˆ¶æŠŠå†…å®¹å®¹å™¨æåˆ°æœ€ä¸Šå±‚ */
    .modal-container {
        position: relative !important;
        z-index: 9999 !important; /* æ•°å€¼è®¾å¾—å¾ˆå¤§ï¼Œä¿è¯åœ¨æœ€ä¸Šé¢ */
        background: #fff; /* ç¡®ä¿èƒŒæ™¯ä¸é€æ˜ */
    }

    /* 2. ç¡®ä¿é®ç½©å±‚åœ¨å†…å®¹å®¹å™¨çš„ä¸‹é¢ */
    .modal-overlay {
        z-index: 999 !important; /* æ•°å€¼æ¯” container å° */
        background: rgba(0, 0, 0, 0.45) !important; /* å¦‚æœä½ æƒ³è¦æ·±è‰²èƒŒæ™¯ï¼Œç”¨è¿™è¡Œ */
        /* background: rgba(255, 255, 255, 0.75) !important; å¦‚æœä½ æƒ³è¦ä¹‹å‰çš„æµ…è‰²ç£¨ç ‚æ„Ÿï¼Œç”¨è¿™è¡Œ */
    }

</style>
{% endblock %}